<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Profile - FunaGig</title>
    <link rel="stylesheet" href="css/styles.css" />
</head>
<body>
    <header class="navbar">
        <div class="brand">
            <div class="logo"></div> FunaGig
        </div>
    </header>
    <div class="app-layout">
        <aside class="sidebar">
            <div class="title" style="display:flex; align-items:center; gap:10px;">
                <div class="cover-img" style="width:36px;height:36px;">ST</div> Student User
            </div>
            <nav class="navlist">
                <a class="navitem" href="student-dashboard.html">Dashboard</a>
                <a class="navitem" href="gigs.html">Gigs</a>
                <a class="navitem active" href="student-profile.html">Profile</a>
                <a class="navitem" href="student-messaging.html">Messages</a>
                <a class="navitem" href="#" onclick="Auth.logout(); return false;">Log out</a>
            </nav>
        </aside>
        <main class="content">
            <h1 class="h1">Profile</h1>
            <form id="profile-form">
                <div class="section">
                    <h2>Personal Info</h2>
                    <div class="flex items-center gap-10">
                        <div class="cover-img">JD</div>
                        <button type="button" class="btn secondary">Change Photo</button>
                    </div>
                    <input class="input mt-10" name="name" value="Student User" placeholder="Full Name" />
                    <input class="input mt-10" name="email" value="john@example.com" placeholder="Email" />
                    <input class="input mt-10" name="phone" value="+256 123 456 789" placeholder="Phone" />
                </div>
                <div class="section mt-20">
                    <h2>Academic Info</h2>
                    <input class="input" name="university" value="Makerere University" placeholder="University" />
                    <input class="input mt-10" name="major" value="Computer Science" placeholder="Major" />
                    <select class="select mt-10" name="year"><option>Year 2</option></select>
                </div>
                <div class="section mt-20">
                    <h2>Skills</h2>
                    <div class="flex flex-wrap gap-8">
                        <span class="pill blue">Web Dev</span> <!-- Add/remove via JS -->
                    </div>
                    <input class="input mt-10" placeholder="Add Skill" />
                </div>
                <div class="section mt-20">
                    <h2>Availability & Payment</h2>
                    <select class="select" name="availability"><option>Part-Time</option></select>
                    <input class="input mt-10" name="payment" value="Bank ****1234" placeholder="Payment Info" />
                </div>
                <button type="submit" class="btn mt-20">Save Changes</button>
            </form>

            <div id="applications" class="section mt-40">
                <h2>Applications History</h2>
                <div class="filters flex gap-10">
                    <select><option>Status: All</option></select>
                    <select><option>Sort: Newest</option></select>
                    <input placeholder="Search" />
                </div>
                <table class="table mt-10">
                    <thead><tr><th>Gig</th><th>Status</th><th>Date</th></tr></thead>
                    <tbody>
                        <tr><td>Web Dev</td><td><span class="pill yellow">Pending</span></td><td>2024-09-15</td></tr>
                        <!-- More rows -->
                    </tbody>
                </table>
                <div class="text-right subtle mt-10">1 2 3 … 10 »</div>
            </div>

            <div class="section mt-20">
                <h2>Completed Gigs</h2>
                <table class="table">
                    <thead><tr><th>Gig</th><th>Client</th><th>Earnings</th><th>Date</th></tr></thead>
                    <tbody>
                        <tr><td>Poster Design</td><td>Events Committee</td><td>sh.200,000</td><td>2025-06-12</td></tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>
    <script src="js/app.js" type="module"></script>
    <script>
        // Load user data and update profile
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in
            if (!Auth.isLoggedIn()) {
                window.location.href = 'auth.html';
                return;
            }
            
            const user = Auth.getUser();
            if (user) {
                // Check if user is a student
                if (user.type !== 'student') {
                    showNotification('Access denied. This page is for students only.', 'error');
                    window.location.href = user.type === 'business' ? 'business-dashboard.html' : 'auth.html';
                    return;
                }
                
                // Update user name in sidebar
                const userName = user.name;
                const userInitials = userName.split(' ').map(n => n[0]).join('').toUpperCase();
                
                // Update sidebar
                const sidebarTitle = document.querySelector('.sidebar .title');
                if (sidebarTitle) {
                    sidebarTitle.innerHTML = `<div class="cover-img" style="width:36px;height:36px;">${userInitials}</div> ${userName}`;
                }
                
                // Update profile form with user data
                updateProfileForm(user);
                
                // Load applications and completed gigs
                loadApplications();
                loadCompletedGigs();
            }
        });
        
        function updateProfileForm(user) {
            // Update form fields with user data
            const nameField = document.querySelector('input[name="name"]');
            const emailField = document.querySelector('input[name="email"]');
            const universityField = document.querySelector('input[name="university"]');
            const majorField = document.querySelector('input[name="major"]');
            
            if (nameField) nameField.value = user.name || '';
            if (emailField) emailField.value = user.email || '';
            if (universityField) universityField.value = user.university || '';
            if (majorField) majorField.value = user.major || '';
            
            // Update avatar initials
            const avatar = document.querySelector('.cover-img');
            if (avatar) {
                avatar.textContent = user.name ? user.name.split(' ').map(n => n[0]).join('').toUpperCase() : 'U';
            }
        }
        
        async function loadApplications() {
            try {
                const response = await apiFetch('/applications');
                if (response.success) {
                    updateApplicationsTable(response.applications);
                }
            } catch (error) {
                console.error('Failed to load applications:', error);
                showNotification('Failed to load applications', 'error');
            }
        }
        
        function updateApplicationsTable(applications) {
            const tbody = document.querySelector('#applications tbody');
            if (tbody && applications) {
                tbody.innerHTML = applications.map(app => `
                    <tr>
                        <td>${app.gig_title || 'N/A'}</td>
                        <td><span class="pill ${getStatusClass(app.status)}">${app.status}</span></td>
                        <td>${new Date(app.applied_at).toLocaleDateString()}</td>
                    </tr>
                `).join('');
            }
        }
        
        async function loadCompletedGigs() {
            try {
                const response = await apiFetch('/applications?status=completed');
                if (response.success) {
                    updateCompletedGigsTable(response.applications);
                }
            } catch (error) {
                console.error('Failed to load completed gigs:', error);
            }
        }
        
        function updateCompletedGigsTable(completedGigs) {
            const tbody = document.querySelector('.section:last-child tbody');
            if (tbody && completedGigs) {
                tbody.innerHTML = completedGigs.map(gig => `
                    <tr>
                        <td>${gig.gig_title || 'N/A'}</td>
                        <td>${gig.business_name || 'N/A'}</td>
                        <td>sh.${gig.budget || 0}</td>
                        <td>${new Date(gig.completed_at).toLocaleDateString()}</td>
                    </tr>
                `).join('');
            }
        }
        
        function getStatusClass(status) {
            switch(status) {
                case 'accepted': return 'green';
                case 'pending': return 'yellow';
                case 'rejected': return 'red';
                case 'completed': return 'blue';
                default: return 'gray';
            }
        }
        
        // Handle profile form submission
        document.getElementById('profile-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                name: document.querySelector('input[name="name"]').value,
                email: document.querySelector('input[name="email"]').value,
                phone: document.querySelector('input[name="phone"]').value,
                university: document.querySelector('input[name="university"]').value,
                major: document.querySelector('input[name="major"]').value
            };
            
            // Update profile via API
            apiFetch('/profile', {
                method: 'POST',
                body: JSON.stringify(formData)
            })
            .then(response => {
                if (response.success) {
                    showNotification('Profile updated successfully!', 'success');
                    // Update stored user data
                    const user = Auth.getUser();
                    Object.assign(user, formData);
                    Auth.setUser(user);
                } else {
                    showNotification('Failed to update profile', 'error');
                }
            })
            .catch(error => {
                console.error('Profile update error:', error);
                showNotification('Failed to update profile', 'error');
            });
        });
    </script>
</body>
</html>