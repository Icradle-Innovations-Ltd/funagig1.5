<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gigs - FunaGig</title>
    <link rel="stylesheet" href="css/styles.css" />
</head>
<body>
    <header class="navbar">
        <div class="brand">
            <div class="logo"></div> FunaGig
        </div>
    </header>
    <div class="app-layout">
        <aside class="sidebar">
            <div class="title" style="display:flex; align-items:center; gap:10px;">
                <div class="cover-img" style="width:36px;height:36px;">ST</div> Student User
            </div>
            <nav class="navlist">
                <a class="navitem" href="student-dashboard.html">Dashboard</a>
                <a class="navitem active" href="gigs.html">Gigs</a>
                <a class="navitem" href="student-profile.html">Profile</a>
                <a class="navitem" href="student-messaging.html">Messages</a>
                <a class="navitem" href="#" onclick="Auth.logout(); return false;">Log out</a>
            </nav>
        </aside>
        <main class="content">
            <h1 class="h1">Gigs</h1>
            <div class="tabs">
                <button class="tab active" onclick="showTab('browse')">Browse</button>
                <button class="tab" onclick="showTab('saved')">Saved</button>
                <button class="tab" onclick="showTab('interested')">Interested</button>
            </div>

            <!-- Browse Tab -->
            <div id="browse" class="tab-content" style="display:block;">
                <div class="flex items-center justify-between mb-20">
                    <h2>Find Gigs</h2>
                    <input class="input" placeholder="Search" />
                </div>
                <!-- Filters -->
                <div class="section">
                    <h3>Filters</h3>
                    <div class="grid-3">
                        <select class="select"><option>Skill</option></select>
                        <select class="select"><option>Compensation</option></select>
                        <select class="select"><option>Location</option></select>
                    </div>
                    <button class="btn mt-10">Apply</button>
                </div>
                <!-- Gig List -->
                <div class="card-grid mt-20">
                    <!-- Example Gig -->
                    <article class="section" style="display:grid; grid-template-columns:160px 1fr auto; gap:16px;">
                        <div style="height:120px; background:#dbeafe; border-radius:12px;"></div>
                        <div>
                            <h3>Social Media Management</h3>
                            <p class="subtle">Manage event socials.</p>
                            <span class="pill blue">Social Media</span>
                        </div>
                        <div style="display:grid; gap:10px;">
                            <button class="btn secondary">Save</button>
                            <button class="btn">Apply</button>
                            <button class="btn secondary">Interest</button>
                        </div>
                    </article>
                    <!-- More gigs... -->
                </div>
                <div class="text-right subtle mt-20">1 2 3 … 10 »</div>
            </div>

            <!-- Saved Tab -->
            <div id="saved" class="tab-content" style="display:none;">
                <h2>Saved Gigs</h2>
                <div id="saved-list" class="card-grid">
                    <!-- Load via JS, similar to gigs -->
                </div>
            </div>

            <!-- Interested Tab -->
            <div id="interested" class="tab-content" style="display:none;">
                <h2>Interested Gigs</h2>
                <div id="interested-list" class="card-grid">
                    <!-- Load via JS -->
                </div>
            </div>
        </main>
    </div>
    <script>
        // Load user data and update sidebar
        document.addEventListener('DOMContentLoaded', function() {
            // Wait for Auth to be available
            function initPage() {
                // Check if user is logged in
                if (!Auth.isLoggedIn()) {
                    window.location.href = 'auth.html';
                    return;
                }
                
                const user = Auth.getUser();
                if (user) {
                    // Check if user is a student
                    if (user.type !== 'student') {
                        showNotification('Access denied. This page is for students only.', 'error');
                        window.location.href = user.type === 'business' ? 'business-dashboard.html' : 'auth.html';
                        return;
                    }
                
                // Update user name in sidebar
                const userName = user.name;
                const userInitials = userName.split(' ').map(n => n[0]).join('').toUpperCase();
                
                // Update sidebar
                const sidebarTitle = document.querySelector('.sidebar .title');
                if (sidebarTitle) {
                    sidebarTitle.innerHTML = `<div class="cover-img" style="width:36px;height:36px;">${userInitials}</div> ${userName}`;
                }
                
                // Load gigs data
                loadGigs();
            }
            
            // Check if Auth is available, if not wait for it
            if (typeof Auth !== 'undefined') {
                initPage();
            } else {
                window.addEventListener('appReady', initPage);
            }
        });
        
        async function loadGigs() {
            try {
                const response = await apiFetch('/gigs');
                if (response.success) {
                    updateGigsList(response.gigs);
                }
            } catch (error) {
                console.error('Failed to load gigs:', error);
                showNotification('Failed to load gigs', 'error');
            }
        }
        
        function updateGigsList(gigs) {
            const gigsContainer = document.querySelector('.card-grid');
            if (gigsContainer && gigs) {
                gigsContainer.innerHTML = gigs.map(gig => `
                    <article class="section" style="display:grid; grid-template-columns:160px 1fr auto; gap:16px;">
                        <div style="height:120px; background:#dbeafe; border-radius:12px;"></div>
                        <div>
                            <h3>${gig.title}</h3>
                            <p class="subtle">${gig.description.substring(0, 100)}...</p>
                            <span class="pill blue">${gig.skills || 'General'}</span>
                            <div class="subtle mt-5">Budget: sh.${gig.budget.toLocaleString()}</div>
                        </div>
                        <div style="display:grid; gap:10px;">
                            <button class="btn secondary" onclick="saveGig(${gig.id})">Save</button>
                            <button class="btn" onclick="applyToGig(${gig.id})">Apply</button>
                            <button class="btn secondary" onclick="showInterest(${gig.id})">Interest</button>
                        </div>
                    </article>
                `).join('');
            }
        }
        
        function saveGig(gigId) {
            // Implement save gig functionality
            showNotification('Gig saved!', 'success');
        }
        
        function applyToGig(gigId) {
            const message = prompt('Add a message to your application:');
            if (message !== null) {
                apiFetch('/applications', {
                    method: 'POST',
                    body: JSON.stringify({
                        gig_id: gigId,
                        message: message
                    })
                })
                .then(response => {
                    if (response.success) {
                        showNotification('Application submitted successfully!', 'success');
                    } else {
                        showNotification('Failed to submit application', 'error');
                    }
                })
                .catch(error => {
                    console.error('Application error:', error);
                    showNotification('Failed to submit application', 'error');
                });
            }
        }
        
        function showInterest(gigId) {
            showNotification('Interest noted!', 'info');
        }
        
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            document.getElementById(tabId).style.display = 'block';
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
        }
    </script>
    <script src="js/app.js" type="module"></script>
</body>
</html>